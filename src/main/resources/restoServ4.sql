 drop TABLE if exists EMPLEADOS, CATEGORIAS, CLIENTES, ORDENES, DETALLE_ORDENES, PRODUCTOS;

CREATE TABLE EMPLEADOS(
empl_id SERIAL PRIMARY KEY,
codigo int NOT NULL,
nom_empl char(30) NULL,
apellido_empl char(30) NULL
);

CREATE TABLE CATEGORIAS(
cat_id SERIAL PRIMARY KEY,
nom_cat char(50) NOT NULL
);

CREATE TABLE ORDENES(
orden_id SERIAL PRIMARY KEY,
empl_id int NOT NULL,
FECHAORDEN date NOT NULL,
telf integer NOT NULL,
precio_total numeric NOT NULL,
hecho boolean NOT NULL
);

CREATE TABLE PRODUCTOS(
prod_id SERIAL PRIMARY KEY,
cat_id int NOT NULL,
nom_prod char(30) NOT NULL,
precio numeric NOT NULL
);

CREATE TABLE CLIENTES(
telf integer PRIMARY KEY,
nom_cli char(30) NOT NULL,
direccion char(50) NULL,
comentario char(50) NULL,
ultima_orden_id int NULL,
FOREIGN KEY (ultima_orden_id) REFERENCES ORDENES(orden_id) ON DELETE SET NULL
);

CREATE TABLE DETALLE_ORDENES(
detalle_id SERIAL PRIMARY KEY,
orden_id int NOT NULL,
prod_id int NOT NULL,
CANTIDAD int NOT NULL,
CONSTRAINT FK_DETALLE_ORDENES_ORDEN FOREIGN KEY (orden_id) REFERENCES ORDENES (orden_id),
CONSTRAINT FK_DETALLE_ORDENES_PRODUCTO FOREIGN KEY (prod_id) REFERENCES PRODUCTOS (prod_id)
);


ALTER TABLE ORDENES
ADD CONSTRAINT FK_ORDENES_CLIEN_ORD_CLIENTES FOREIGN KEY(telf)
REFERENCES CLIENTES (telf)
ON DELETE RESTRICT 
ON UPDATE RESTRICT;

ALTER TABLE ORDENES ADD CONSTRAINT FK_ORDENES_EMPLE_ORD_EMPLEADO FOREIGN KEY(empl_id)
REFERENCES EMPLEADOS (empl_id)
ON DELETE RESTRICT ON UPDATE RESTRICT;

ALTER TABLE DETALLE_ORDENES ADD CONSTRAINT FK_DETALLE_ORDENES_ORDEN FOREIGN KEY(orden_id)
REFERENCES ORDENES (orden_id)
ON DELETE CASCADE ON UPDATE RESTRICT;

ALTER TABLE DETALLE_ORDENES ADD CONSTRAINT FK_DETALLE_ORDENES_PRODUCTO FOREIGN KEY(prod_id)
REFERENCES PRODUCTOS (prod_id)
ON DELETE RESTRICT ON UPDATE RESTRICT;

ALTER TABLE PRODUCTOS ADD CONSTRAINT FK_PRODUCTO_CATE_PROD_CATEGORIA FOREIGN KEY(cat_id)
REFERENCES CATEGORIAS (cat_id)
ON DELETE RESTRICT ON UPDATE RESTRICT;

/*INSERCIÓN DE DATOS EN LA BASE                */

insert into CATEGORIAS (cat_id, nom_cat) values (1, 'PIZZA');
insert into CATEGORIAS (cat_id, nom_cat) values (2, 'BEBIDA');
insert into CATEGORIAS (cat_id, nom_cat) values (3, 'POSTRE');
insert into CATEGORIAS (cat_id, nom_cat) values (4, 'ENTRANTE');

INSERT INTO PRODUCTOS VALUES (1,1,'P CARBONARA',10.99);
INSERT INTO PRODUCTOS VALUES (2,1,'P BARBACOA',10.99);
INSERT INTO PRODUCTOS VALUES (3,1,'P HAWAIANA',9.99);
INSERT INTO PRODUCTOS VALUES (4,1,'P CARNIVORA',13.99);
INSERT INTO PRODUCTOS VALUES (5,1,'P VEGETAL',12.99);
INSERT INTO PRODUCTOS VALUES (6,1,'P 4 QUESOS',10.99);
INSERT INTO PRODUCTOS VALUES (7,1,'P 6 QUESOS',13.99);
INSERT INTO PRODUCTOS VALUES (8,1,'P IBERICA',14.99);
INSERT INTO PRODUCTOS VALUES (9,1,'P MEDITERRANEA',11.99);
INSERT INTO PRODUCTOS VALUES (10,2,'COCA-COLA',1.50);
INSERT INTO PRODUCTOS VALUES (11,2,'FANTA NARANJA',1.50);
INSERT INTO PRODUCTOS VALUES (12,2,'FANTA LIMON',1.50);
INSERT INTO PRODUCTOS VALUES (13,2,'AGUA',1.00);
INSERT INTO PRODUCTOS VALUES (14,2,'CERVEZA',1.80);
INSERT INTO PRODUCTOS VALUES (15,2,'COCA-COLA 0',1.50);
INSERT INTO PRODUCTOS VALUES (16,2,'REDBULL',2.00);
INSERT INTO PRODUCTOS VALUES (17,2,'AQUARIUS NARANJA',1.80);
INSERT INTO PRODUCTOS VALUES (18,2,'AQUARIUS LIMON',1.80);
INSERT INTO PRODUCTOS VALUES (19,2,'ZUMO PIÑA',1.20);
INSERT INTO PRODUCTOS VALUES (20,2,'ZUMO NARANJA',1.20);
INSERT INTO PRODUCTOS VALUES (21,3,'HELADO COOKIE',3.40);
INSERT INTO PRODUCTOS VALUES (22,3,'TARTA DE QUESO',5.00);
INSERT INTO PRODUCTOS VALUES (23,3,'HELADO FRESA',3.40);
INSERT INTO PRODUCTOS VALUES (24,3,'COULANT DE CHOCOLATE',5.50);
INSERT INTO PRODUCTOS VALUES (25,3,'BROWNIE',5.00);
INSERT INTO PRODUCTOS VALUES (26,3,'FLAN',4.00);
INSERT INTO PRODUCTOS VALUES (27,3,'TARTA SACHER',3.40);
INSERT INTO PRODUCTOS VALUES (28,4,'ALITAS DE POLLO',6.50);
INSERT INTO PRODUCTOS VALUES (29,4,'TIRAS DE POLLO',6.50);
INSERT INTO PRODUCTOS VALUES (30,4,'QUESO FRITO',5.40);
INSERT INTO PRODUCTOS VALUES (31,4,'PATATAS QUESO Y BACON',6.50);
INSERT INTO PRODUCTOS VALUES (32,4,'PAN PIZZA',7.50);

set datestyle to dmy;

INSERT INTO EMPLEADOS VALUES (1,1011,'SARA', 'CRUZ');
INSERT INTO EMPLEADOS VALUES (2,1012,'MARIO', 'SANCHEZ');
INSERT INTO EMPLEADOS VALUES (3,1013,'VERONICA', 'ARIAS');
INSERT INTO EMPLEADOS VALUES (4,1014,'PABLO', 'CELY');
INSERT INTO EMPLEADOS VALUES (5,1015,'DIEGO', 'ANDRADE');
INSERT INTO EMPLEADOS VALUES (6,1016,'CAROLINA', 'MALDONADO');
INSERT INTO EMPLEADOS VALUES (7,1017,'MARIA', 'NOBOA');

INSERT INTO CLIENTES VALUES (666999666,'CARLOS','AV.AMAZONAS, 7, 1L','llevar datáfono', NULL);
INSERT INTO CLIENTES VALUES (666333666,'PAULA','CALLE HERRERO, 54','CAMBIO 50', NULL);

SELECT setval(pg_get_serial_sequence('empleados', 'empl_id'), coalesce(max(empl_id)+1, 1), false) FROM empleados;
SELECT setval(pg_get_serial_sequence('categorias', 'cat_id'), coalesce(max(cat_id)+1, 1), false) FROM categorias;
SELECT setval(pg_get_serial_sequence('ordenes', 'orden_id'), coalesce(max(orden_id)+1, 1), false) FROM ordenes;
SELECT setval(pg_get_serial_sequence('detalle_ordenes', 'detalle_id'), coalesce(max(detalle_id)+1, 1), false) FROM detalle_ordenes;
SELECT setval(pg_get_serial_sequence('productos', 'prod_id'), coalesce(max(prod_id)+1, 1), false) FROM productos;

CREATE OR REPLACE FUNCTION get_total_income_by_date(order_date DATE)
RETURNS NUMERIC AS $$
DECLARE
    total_income NUMERIC := 0;
BEGIN
    -- Calcula el total de ingresos para la fecha especificada
    SELECT COALESCE(SUM(precio_total), 0) INTO total_income
    FROM ORDENES
    WHERE FECHAORDEN = order_date;

    RETURN total_income;
END;
$$ LANGUAGE plpgsql;